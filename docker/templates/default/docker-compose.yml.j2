services:
  postgres:
    image: postgres:17
    container_name: postgres_{{ workspace_name }}
    environment:
      POSTGRES_USER: claude
      POSTGRES_PASSWORD: {{ postgres_password }}
      POSTGRES_DB: claude
    ports:
      - "{{ postgres_port }}:5432"
    volumes:
      - postgres_{{ workspace_name }}_data:/var/lib/postgresql/data
    restart: unless-stopped

  claude:
    build: .
    container_name: claude_{{ workspace_name }}
    hostname: claude-dev
    depends_on:
      - postgres
    ports:
      - "{{ claude_port }}:8000"
    volumes:
      - ./workspace:/workspace
{% if kanban_directory %}
      - {{ kanban_directory }}:/workspace/kanban
{% endif %}
      - ../../home:/home/claude
    environment:
      - DATABASE_URL=postgresql://claude:{{ postgres_password }}@postgres:5432/claude
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=claude
      - POSTGRES_PASSWORD={{ postgres_password }}
      - POSTGRES_DB=claude
      - CLAUDE_HOST_PORT={{ claude_port }}
      - CLAUDE_INTERNAL_PORT=8000
      - POSTGRES_HOST_PORT={{ postgres_port }}
{% if project_name %}
      - PROJECT_NAME={{ project_name }}
{% endif %}
{% if story_name %}
      - STORY_NAME={{ story_name }}
{% endif %}
{% if story_path %}
      - STORY_PATH={{ story_path }}
{% endif %}
{% if git_repo_path %}
      - GIT_REPO_PATH={{ git_repo_path }}
{% endif %}
{% if git_url %}
      - PROJECT_GIT_URL={{ git_url }}
{% endif %}
    restart: unless-stopped
    tty: true
    stdin_open: true

volumes:
  postgres_{{ workspace_name }}_data: